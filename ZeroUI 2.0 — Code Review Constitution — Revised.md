
# ZeroUI 2.0 — Code Review Constitution (Cursor)

> Goal: Make every Pull Request (PR) **safe, readable, testable, and traceable** — even when code was generated by AI. Reviews must be in **simple English (8th‑grade)**, focus on **WHY**, and enforce our other Constitutions (Folder, Coding, API Contracts, Comments, Logging, Storage).

---

## 1) Roles & Scope

- **Author:** writes the change, fills PR template, runs self‑checks.
- **Reviewer:** verifies intent, risks, tests, and policy compliance. Gives clear, kind feedback.
- **Gatekeeper (CI):** blocks merges on rule violations.
- **AI Assistant (Cursor):** may propose diffs; must follow this Constitution and stop on rule errors.

**Scope & Size Limits**
- **AI code‑gen task limit:** ≤ **50 LOC** changed unless the prompt includes `LOC_OVERRIDE:<number>`.
- **PR size guidance:** ≤ **300 LOC** changed (tests excluded). If larger, split or include a **Rollout Plan**.
- Sensitive areas (auth, policy, contracts, receipts, migrations) require **CODEOWNERS** approval and may need **two reviewers** (see §9).

SLA: Reviews should start within **2 business days**.

## 2) Golden Rules (non‑negotiable)

1) **Why first.** The PR must state **What changed** and **Why we did it** (problem, constraints, trade‑offs).
2) **Small, coherent diffs.** One intent per PR; feature‑flags for risky changes.
3) **Tests prove behavior.** No code change without tests that **fail before** and **pass after** the change (or receipts proving behavior for non-code config).
4) **Simple English comments.** Follow the Comments Constitution at file/imports/function/variable/logic levels.
5) **Security & privacy first.** No secrets/PII in code, comments, logs, tests, or fixtures.
6) **Reversible.** Include a rollback/disable plan for non‑trivial changes (flags or revert steps).

---

## 3) Review Outcomes & Severity

- **Approve** — meets all checks; minor nits optional.
- **Request changes** — must fix blockers/majors.
- **Comment** — non‑blocking feedback or ideas.

Severity levels the reviewer must tag:
- **Blocker:** merge must **not** proceed (critical gaps).
- **Major:** must fix before merge (important, not existential).
- **Minor:** should fix soon or follow‑up issue.
- **Nit:** style/wording; optional.

---

## 4) Stop Conditions → Error Codes (CI/Reviewer)

- Missing PR context (what/why) .......................... `ERROR:REVIEW_CONTEXT_MISSING`
- Violates Coding/Comments Constitution .................. `ERROR:COMMENT_POLICY_VIOLATION`
- API contract drift (spec vs code) ...................... `ERROR:API_CONTRACT_DRIFT`
- Security/privacy gap (secrets/PII/logs) ................ `ERROR:SECURITY_GAP`
- Logging missing/weak (no request.start/end etc.) ....... `ERROR:LOGGING_GAP`
- Storage rule broken (blob in DB, no metadata row) ...... `ERROR:STORAGE_RULE_VIOLATION`
- Missing/weak tests (no coverage for change) ............ `ERROR:TESTS_MISSING`
- Migration risk (no plan/backout/flags) ................. `ERROR:MIGRATION_RISK`
- Perf regression risk (no budget/measurement) ........... `ERROR:PERF_REGRESSION`
- Observability gap (no metrics/traces/alerts) ........... `ERROR:OBS_GAP`
- Folder/structure naming drift .......................... `ERROR:FOLDER_DRIFT`
- Return contract not honored (diff/file/json) ........... `ERROR:RETURN_CONTRACT_VIOLATION`
- CODEOWNERS approval missing (sensitive areas) .......... `ERROR:CODEOWNERS_MISSING`
- Two‑person rule not met (sensitive areas) .............. `ERROR:TWO_PERSON_RULE_VIOLATION`
- AI provenance missing in PR template ................... `ERROR:AI_PROVENANCE_MISSING`
- API receipts/contract diffs not attached ............... `ERROR:API_RECEIPTS_MISSING`
- Dependency license/CVE policy failed ................... `ERROR:DEPENDENCY_POLICY_FAIL`

---


## 5) Review Procedure (simple checklist)

### A) Intent & Context (read first)
- Problem statement clear? Why now?
- Link to issue/ticket and receipts proving the problem (logs, failing test, steps to reproduce).
- Scope small and single‑intent? Rollout/rollback plan present?
- **Return Contract formats enforced** (Unified Diff / New File / JSON) — PR must include correct output.

### B) Interfaces & Contracts
- OpenAPI/JSON Schemas updated; versioned; backward compatible?
- Inputs/outputs validated; error taxonomy aligned; idempotency documented.
- Cross‑service calls include timeouts, retries, **idempotencyKey**, and **trace propagation**.
- **Attach contract diff outputs and receipts** for contract changes.

### C) Security & Privacy
- No secrets/PII in code/comments/tests/logs.
- AuthZ/AuthN checks explicit; least privilege.
- Inputs sanitized; outputs redacted where needed.
- **Security/Privacy Impact** block filled in PR.

### D) Storage & Data
- Database vs files choice follows Storage Constitution (≤256KB in DB; blobs in files + DB metadata).
- **Migration safety recipe:** additive‑first, concurrent index, backfill plan, dual read/write if needed, and a safe **down** path or disable flag.
- Data retention and tenant isolation applied.

### E) Logging & Troubleshooting
- JSONL logs with **required fields** and **schema version**.
- Exactly one `request.start` and `request.end`; W3C headers propagated.
- LLM events: token counts, `prompt_hash/output_hash`; no raw prompts/outputs.
- Error logs carry `error.code` and `stack_fingerprint`.
- **Parity check**: reviewer verifies logging matches the Logging Constitution.

### F) Comments & Readability
- File/imports/function/variable/logic comments added/updated, in simple English.
- RATIONALE/PLAN blocks for tricky logic.
- Banned words avoided; short sentences.
- **Link to Comments Constitution stop codes** for enforcement.

### G) Tests (prove it works)
- Unit/integration tests cover new paths and failure modes.
- Golden test data is synthetic; redaction checked.
- Benchmarks or perf receipts for performance‑sensitive changes.

### H) Observability & Ops
- Metrics/traces/alerts updated.
- Feature flags named; owner and expiry set.
- Laptop‑first notes: run commands, env vars, local paths.

### I) Dependencies & Risk
- New deps reviewed (license allowlist, size, security — CVE threshold enforced).
- Risk label (Low/Med/High) added with mitigation.

---


## 6) Evidence Required in PR

- **Screenshots or log snippets** (redacted) showing success/failure.
- **Receipts** for significant actions (append‑only JSONL).
- **Test results** (pass/fail) and, if relevant, benchmark numbers.
- **Contract diffs** (`openapi.yaml`, schema JSON) and migration IDs.

---

## 7) Micro‑Prompt Footer — Code Review (attach to AI review tasks)

```text
MICRO_PROMPT_FOOTER — Code Review

=== MUST REVIEW ===
- Intent/why; single scope; rollout/rollback plan.
- Contracts stable; inputs/outputs validated; errors/idempotency documented.
- Security/privacy; storage choice; logging schema; comments in simple English.
- Tests prove behavior; metrics/traces/alerts updated.

=== RETURN ===
Output one of: Approve | Request changes | Comment. Include severity tags (Blocker/Major/Minor/Nit), line‑level notes, and suggested diffs.
```

---

## 8) PR Template Block — Code Review (paste into `.github/pull_request_template.md`)

```markdown
### PR Intent
- **What changed:** 
- **Why now (problem/constraint):** 
- **Scope:** 
- **Risk (Low/Med/High) + Mitigation:** 
- **Rollout/rollback plan:** 

### AI Provenance
- **generated_by:** Cursor
- **model:** 
- **prompt_hash:** 
- **assumptions/limits:** 

### Security/Privacy Impact
- **New data flows or scopes:** 
- **AuthZ/AuthN changes:** 
- **PII risk & mitigations:** 

### Evidence
- [ ] Logs/receipts attached (redacted)
- [ ] Contract diffs (OpenAPI/Schema) included (+ publish/receipt where applicable)
- [ ] Test results pasted (unit/integration)
- [ ] Screenshots/benchmarks & **Perf Receipt** (if relevant)

### Self‑Check (Author)
- [ ] Comments updated (simple English; WHY + PLAN)
- [ ] Logging meets schema; request.start/end present
- [ ] Storage rules followed; migrations safe (additive‑first, concurrent index, backfill, dual RW if needed, down path)
- [ ] Security/privacy reviewed; no secrets/PII
- [ ] Observability updated (metrics/traces/alerts)
- [ ] CODEOWNERS approval(s) requested (sensitive areas); two reviewers tagged if required
```

---


## 9) Automation (CI/Pre‑commit)

- **Lint & format:** ruff/black (Python), eslint/biome (TS).
- **Contracts:** diff and validate OpenAPI/Schema JSON; fail on breaking changes; require contract publish receipt where applicable.
- **Comments:** check for file headers, function docs, PLAN blocks (regex/rules) — enforce Comments Constitution stop codes.
- **Logging:** validate sample log lines against `docs/log_schema_v1.json`; fail on missing fields/oversize; enforce request.start/end.
- **Security:** secret scanners; dependency audit with **license allowlist** and **CVE threshold** gate.
- **Storage:** forbid blobs in DB; require DB metadata rows for file writes (static checks where possible).
- **Tests:** require new/changed paths covered; run unit/integration; collect perf receipts for hot paths.
- **Governance:** require **CODEOWNERS** approval for sensitive paths and **two reviewers** (owner + guild) where mandated.
- **Receipts:** ensure `receipt.emit` present for privileged/business‑critical actions.

---


## 10) Review Comment Style (simple English)

- Be kind. Focus on the code, not the person.
- Explain **why** you suggest a change. Use short sentences.
- Offer a **concrete diff** when possible.
- Mark severity: **Blocker/Major/Minor/Nit**.
- Ask clarifying questions; avoid sarcasm or jargon.

**Examples**  
- *Blocker:* “Idempotency not enforced on retry; please add idempotencyKey and conflict handling.”  
- *Major:* “API response adds a field without version bump; please update OpenAPI and mark as non‑breaking.”  
- *Minor:* “Comment uses jargon (‘instantiate’). Please rewrite in simple English.”  
- *Nit:* “Consider renaming var to match style: `maxBatch` → `MAX_BATCH`.”

---

## 11) Return Contracts (review output)

- **Approve:** brief summary + any minor nits.
- **Request changes:** list blockers/majors with bullet points and suggested fix.
- **Comment:** ideas or questions; no merge block.

---

## 12) Quick Reviewer Checklist (one screen)

- [ ] Why now + single scope  
- [ ] AI provenance filled (generated_by/model/prompt_hash)  
- [ ] Contracts & migrations updated (diffs + receipts)  
- [ ] Security/privacy & storage rules ok  
- [ ] Logging schema & request.start/end ok  
- [ ] Comments (simple English) ok  
- [ ] Tests prove behavior (+ perf receipt if hot path)  
- [ ] Observability updated  
- [ ] CODEOWNERS approval/two‑person rule satisfied  
- [ ] Rollback plan exists
