# Receipt Schema Cross-Reference

## Overview

This document provides a cross-reference for receipt schemas across the ZeroUI 2.0 codebase. The Extension is receipt-driven, and GSMD invariants define snapshot expectations. This document enumerates all receipt schema sources and their relationships to avoid drift.

## Normative Schema Sources

### Primary Schema Sources

#### 1. TypeScript Type Definitions (Implementation Reference)

**Location**:
- `src/edge-agent/shared/receipt-types.ts`
- `src/vscode-extension/shared/receipt-parser/ReceiptParser.ts`

**Purpose**: Type definitions used by Edge Agent and VS Code Extension implementations.

**Decision Receipt Interface**:
```typescript
export interface DecisionReceipt {
    receipt_id: string;
    gate_id: string;
    policy_version_ids: string[];
    snapshot_hash: string;
    timestamp_utc: string;
    timestamp_monotonic_ms: number;
    evaluation_point: 'pre-commit' | 'pre-merge' | 'pre-deploy' | 'post-deploy';
    inputs: Record<string, any>;
    decision: {
        status: 'pass' | 'warn' | 'soft_block' | 'hard_block';
        rationale: string;
        badges: string[];
    };
    evidence_handles: EvidenceHandle[];
    actor: {
        repo_id: string;
        machine_fingerprint?: string;
        type?: 'human' | 'ai' | 'automated';
    };
    context?: {
        surface?: 'ide' | 'pr' | 'ci';
        branch?: string;
        commit?: string;
        pr_id?: string;
    };
    override?: {
        reason: string;
        approver: string;
        timestamp: string;
        override_id?: string;
    };
    data_category?: 'public' | 'internal' | 'confidential' | 'restricted';
    degraded: boolean;
    signature: string;
}
```

**Feedback Receipt Interface**:
```typescript
export interface FeedbackReceipt {
    feedback_id: string;
    decision_receipt_id: string;
    pattern_id: 'FB-01' | 'FB-02' | 'FB-03' | 'FB-04';
    choice: 'worked' | 'partly' | 'didnt';
    tags: string[];
    actor: {
        repo_id: string;
        machine_fingerprint?: string;
    };
    timestamp_utc: string;
    signature: string;
}
```

**Evidence Handle Interface**:
```typescript
export interface EvidenceHandle {
    url: string;
    type: string;
    description: string;
    expires_at?: string;
}
```

#### 2. GSMD Module Receipt Schemas (Normative for Required/Optional Fields)

**Location**: `gsmd/gsmd/modules/M{01-20}/receipts_schema/v1/snapshot.json`

**Purpose**: Defines required and optional receipt fields per module. These are the **normative source** for field requirements as defined by GSMD invariants.

**Structure**:
```json
{
  "receipts": {
    "required": [
      "decision",
      "rationale",
      "policy_snapshot_hash",
      "policy_version_ids",
      "evaluation_point",
      "actor_id",
      "repo_id",
      "timestamps.hw",
      "signature"
    ],
    "optional": [
      "advisories[]",
      "evidence_ids[]",
      "cohort"
    ]
  }
}
```

**Example**: `gsmd/gsmd/modules/M03/receipts_schema/v1/snapshot.json`

> **Note**: Each module (M01-M20) has its own `receipts_schema/v1/snapshot.json` file. The `receipts.required` and `receipts.optional` arrays define the normative field requirements for that module's receipts.

#### 3. GSMD Minimal Decision Receipt Schema

**Location**: `gsmd/schema/receipt.schema.json`

**Purpose**: Minimal JSON Schema for decision receipts (v1).

**Key Fields**:
- `decision`: enum `["pass", "warn", "soft_block", "hard_block"]`
- `rationale`: string
- `policy_snapshot_hash`: string (pattern: `^sha256:[0-9a-f]{64}$`)
- `policy_version_ids`: array of strings
- `evaluation_point`: enum `["pre-commit", "pre-merge", "pre-deploy", "post-deploy"]`
- `actor_id`: string
- `repo_id`: string
- `timestamps.hw`: string | number | integer
- `signature`: string

**Required Fields**: All fields listed above are required.

#### 4. Contract Feedback Receipt Schemas

**Location**: `contracts/*/schemas/feedback_receipt.schema.json`

**Purpose**: JSON Schema definitions for feedback receipts used in contract validation.

**Key Fields**:
- `feedback_id`: string
- `decision_receipt_id`: string
- `pattern_id`: enum `["FB-01", "FB-02", "FB-03", "FB-04"]`
- `choice`: enum `["worked", "partly", "didnt"]`
- `tags`: array of strings
- `actor.repo_id`: string (required)
- `actor.machine_fingerprint`: string (optional)
- `timestamp_utc`: string (ISO 8601 date-time)
- `signature`: string

**Required Fields**: All fields listed above are required.

## Schema Mapping

### Decision Receipt Field Mapping

| TypeScript Field | GSMD Schema Field | Module Schema Field | Notes |
|-----------------|-------------------|---------------------|-------|
| `receipt_id` | - | - | Generated by receipt generator |
| `gate_id` | - | - | Gate identifier (e.g., "edge-agent") |
| `policy_version_ids` | `policy_version_ids` | `policy_version_ids` | Array of policy version IDs |
| `snapshot_hash` | `policy_snapshot_hash` | `policy_snapshot_hash` | SHA256 hash of policy snapshot |
| `timestamp_utc` | - | - | ISO 8601 UTC timestamp |
| `timestamp_monotonic_ms` | `timestamps.hw` | `timestamps.hw` | Hardware monotonic timestamp |
| `evaluation_point` | `evaluation_point` | `evaluation_point` | pre-commit / pre-merge / pre-deploy / post-deploy |
| `inputs` | - | - | Task inputs (free-form object) |
| `decision.status` | `decision` | `decision` | Enum: pass/warn/soft_block/hard_block |
| `decision.rationale` | `rationale` | `rationale` | Human-readable explanation |
| `decision.badges` | - | - | Array of badge strings |
| `evidence_handles` | - | `evidence_ids[]` (optional) | Array of evidence handles |
| `actor.repo_id` | `repo_id` | `repo_id` | Repository identifier |
| `actor.machine_fingerprint` | - | - | Optional machine fingerprint |
| `actor.type` | - | - | Optional actor classification (human/ai/automated) |
| `context.surface` | - | - | Optional surface hint (ide/pr/ci) |
| `context.branch` | - | - | Optional branch |
| `context.commit` | - | - | Optional commit hash |
| `context.pr_id` | - | - | Optional PR identifier |
| `override.reason` | - | - | Present when overrides occur |
| `override.approver` | - | - | Present when overrides occur |
| `override.timestamp` | - | - | Present when overrides occur |
| `override.override_id` | - | - | Optional override snapshot id |
| `data_category` | - | - | Optional data classification |
| `degraded` | - | - | Degraded mode flag |
| `signature` | `signature` | `signature` | Cryptographic signature |

> **Note**: The GSMD schema uses different field names in some cases (e.g., `policy_snapshot_hash` vs `snapshot_hash`, `decision` vs `decision.status`). The TypeScript interfaces represent the actual implementation structure.

### Field Name Differences

1. **Policy Snapshot Hash**:
   - GSMD: `policy_snapshot_hash`
   - TypeScript: `snapshot_hash`

2. **Decision Status**:
   - GSMD: `decision` (top-level string)
   - TypeScript: `decision.status` (nested in decision object)

3. **Timestamps**:
   - GSMD: `timestamps.hw` (nested object)
   - TypeScript: `timestamp_utc` and `timestamp_monotonic_ms` (top-level fields)

4. **Actor**:
   - GSMD: `actor_id` and `repo_id` (separate fields)
   - TypeScript: `actor.repo_id` (nested object)

## Schema Validation

### Receipt Parser Validation

The `ReceiptParser` class in `src/vscode-extension/shared/receipt-parser/ReceiptParser.ts` validates receipts using TypeScript type guards:

**Decision Receipt Validation**:
- Validates all required fields from `DecisionReceipt` interface
- Checks field types match interface definitions
- Returns `null` if validation fails

**Feedback Receipt Validation**:
- Validates all required fields from `FeedbackReceipt` interface
- Validates enum values (`pattern_id`, `choice`)
- Returns `null` if validation fails

### GSMD Schema Validation

Module-specific receipt schemas are validated against:
- `receipts.required` array: All listed fields must be present
- `receipts.optional` array: Fields may be present but are not required

## Schema Evolution

### Versioning

- **GSMD Schemas**: Use semantic versioning in `version.major` field
- **TypeScript Interfaces**: Versioned through code changes and type system
- **Contract Schemas**: Versioned in schema title (e.g., "v1 minimal")

### Breaking Changes

Breaking changes to receipt schemas require:
1. Version bump in GSMD schema
2. Update to TypeScript interfaces
3. Update to contract schemas
4. Migration path for existing receipts

## Cross-Reference Summary

### For Decision Receipts

1. **Type Definitions**: `src/edge-agent/shared/receipt-types.ts` (Edge Agent) and `src/vscode-extension/shared/receipt-parser/ReceiptParser.ts` (Extension)
2. **Normative Field Requirements**: `gsmd/gsmd/modules/M{01-20}/receipts_schema/v1/snapshot.json` (per module)
3. **Minimal JSON Schema**: `gsmd/schema/receipt.schema.json`
4. **Contract Schemas**: `contracts/*/schemas/receipt.schema.json` (template, not fully specified)

### For Feedback Receipts

1. **Type Definitions**: `src/edge-agent/shared/receipt-types.ts` and `src/vscode-extension/shared/receipt-parser/ReceiptParser.ts`
2. **Contract Schemas**: `contracts/*/schemas/feedback_receipt.schema.json` (normative JSON Schema)

## Implementation Notes

### Receipt Generation

Receipts are generated by:
- **Edge Agent**: `src/edge-agent/shared/storage/ReceiptGenerator.ts`
- Uses `DecisionReceipt` interface structure
- Populates all required fields per module schema

### Receipt Storage

Receipts are stored in JSONL format:
- **Location**: `{ZU_ROOT}/ide/receipts/{repoId}/{yyyy}/{mm}/receipts.jsonl`
- **Format**: One receipt per line (newline-delimited JSON)
- **Validation**: Receipts are validated before storage

### Receipt Parsing

Receipts are parsed by:
- **VS Code Extension**: `src/vscode-extension/shared/receipt-parser/ReceiptParser.ts`
- **Edge Agent**: Uses same type definitions from `src/edge-agent/shared/receipt-types.ts`

## References

### Type Definitions
- **Edge Agent**: `src/edge-agent/shared/receipt-types.ts`
- **VS Code Extension**: `src/vscode-extension/shared/receipt-parser/ReceiptParser.ts`

### GSMD Schemas
- **Base Schema**: `gsmd/schema/receipt.schema.json`
- **Module Schemas**: `gsmd/gsmd/modules/M{01-20}/receipts_schema/v1/snapshot.json`

### Contract Schemas
- **Feedback Receipt**: `contracts/*/schemas/feedback_receipt.schema.json`
- **Decision Receipt**: `contracts/*/schemas/receipt.schema.json` (template)

### Implementation
- **Receipt Generator**: `src/edge-agent/shared/storage/ReceiptGenerator.ts`
- **Receipt Storage**: `src/edge-agent/shared/storage/ReceiptStorageService.ts`
- **Receipt Reader**: `src/vscode-extension/shared/storage/ReceiptStorageReader.ts`

### Documentation
- **GSMD Guide**: `docs/architecture/modules-mapping-and-gsmd-guide.md`
- **Architecture**: `docs/architecture/edge-agent-architecture.md`
- **VS Code Extension**: `docs/architecture/vs-code-extension-architecture.md`

## Schema Consistency

### Ensuring Consistency

To avoid schema drift:

1. **TypeScript interfaces** are the source of truth for implementation
2. **GSMD module schemas** (`receipts_schema/v1/snapshot.json`) are normative for required/optional fields
3. **Contract schemas** should align with TypeScript interfaces
4. **All schemas** should be validated in CI

### Validation Checklist

- [ ] TypeScript interfaces match actual receipt structure
- [ ] GSMD module schemas list all required fields
- [ ] Contract schemas align with TypeScript interfaces
- [ ] Receipt parser validates against TypeScript interfaces
- [ ] Receipt generator produces receipts matching interfaces
- [ ] Field name mappings documented (GSMD vs TypeScript)
