# 7×4 Architecture, 4-Plane DB, and Memory Model Alignment Matrix

**ID**: AUDIT.7X4.4PLANE.DB+MEMORY.ALIGNMENT.MT-04  
**Date**: 2026-01-03  
**Status**: Alignment Matrix

## A) 7 Layers × 4 Planes Grid

**Note**: The repo documents a "three-tier architecture" (Presentation, Edge Processing, Business Logic), not explicit "7 layers". This matrix maps the three-tier architecture to the 4 planes, with runtime/services, data stores, contracts, and evidence paths.

| Layer | IDE Plane | Tenant Plane | Product Plane | Shared Plane |
|-------|-----------|--------------|---------------|--------------|
| **L1: Presentation** | **Runtime**: VS Code Extension (TypeScript)<br>**Data Store**: Local receipt cache (Postgres), JSONL receipts (`ZU_ROOT/ide/receipts/`)<br>**Contracts**: Receipt schema (`receipt.schema.json`)<br>**Evidence**: `src/vscode-extension/`, `storage-scripts/folder-business-rules.md` (line 125) | **Runtime**: N/A (presentation is IDE-only)<br>**Data Store**: N/A<br>**Contracts**: N/A<br>**Evidence**: N/A | **Runtime**: N/A<br>**Data Store**: N/A<br>**Contracts**: N/A<br>**Evidence**: N/A | **Runtime**: N/A<br>**Data Store**: N/A<br>**Contracts**: N/A<br>**Evidence**: N/A |
| **L2: Edge Processing** | **Runtime**: Edge Agent (TypeScript)<br>**Data Store**: Postgres (`ZEROUI_IDE_DB_URL`), JSONL receipts (`ZU_ROOT/ide/receipts/`), policy cache (`ZU_ROOT/ide/policy/`)<br>**Contracts**: Receipt schema, policy snapshot schema<br>**Evidence**: `src/edge-agent/`, `infra/db/schema_pack/migrations/pg/001_core.sql` | **Runtime**: Tenant adapters (Python/FastAPI)<br>**Data Store**: Postgres (`zeroui_tenant_pg`), JSONL evidence (`ZU_ROOT/tenant/{tenant-id}/{region}/evidence/data/`)<br>**Contracts**: Receipt schema, evidence envelope schema<br>**Evidence**: `infra/docker/compose.yaml` (postgres_tenant), `storage-scripts/folder-business-rules.md` (line 137) | **Runtime**: Product services (Python/FastAPI)<br>**Data Store**: Postgres (`zeroui_product_pg`), policy registry (`ZU_ROOT/product/{region}/policy/registry/`)<br>**Contracts**: Policy snapshot schema, policy bundle schema<br>**Evidence**: `infra/docker/compose.yaml` (postgres_product), `storage-scripts/folder-business-rules.md` (line 154) | **Runtime**: Shared services (Python/FastAPI)<br>**Data Store**: Postgres (`zeroui_shared_pg`), shared artifacts (`ZU_ROOT/shared/{org-id}/{region}/`)<br>**Contracts**: Provider registry schema, eval run schema<br>**Evidence**: `infra/docker/compose.yaml` (postgres_shared), `storage-scripts/folder-business-rules.md` (line 162) |
| **L3: Business Logic** | **Runtime**: N/A (business logic is cloud-only)<br>**Data Store**: N/A<br>**Contracts**: N/A<br>**Evidence**: N/A | **Runtime**: Client services (Python/FastAPI)<br>**Data Store**: Postgres (`zeroui_tenant_pg`), tenant context (`ZU_ROOT/tenant/{tenant-id}/{region}/context/`)<br>**Contracts**: Tenant-specific service contracts<br>**Evidence**: `src/cloud_services/client-services/`, `storage-scripts/folder-business-rules.md` (line 145) | **Runtime**: Product services (Python/FastAPI)<br>**Data Store**: Postgres (`zeroui_product_pg`), policy registry (`ZU_ROOT/product/{region}/policy/registry/`)<br>**Contracts**: Policy lifecycle contracts<br>**Evidence**: `src/cloud_services/product_services/`, `storage-scripts/folder-business-rules.md` (line 154) | **Runtime**: Shared services (Python/FastAPI)<br>**Data Store**: Postgres (`zeroui_shared_pg`), shared artifacts (`ZU_ROOT/shared/{org-id}/{region}/`)<br>**Contracts**: Shared service contracts (provider registry, eval, SBOM)<br>**Evidence**: `src/cloud_services/shared-services/`, `storage-scripts/folder-business-rules.md` (line 162) |
| **L4: Data & Memory** | **Runtime**: Postgres cache, JSONL receipts<br>**Data Store**: Postgres (`ZEROUI_IDE_DB_URL`), JSONL (`ZU_ROOT/ide/receipts/`)<br>**Contracts**: Core schema contract (`infra/db/schema_pack/canonical_schema_contract.json`)<br>**Evidence**: `infra/db/schema_pack/migrations/pg/001_core.sql` | **Runtime**: Postgres DB, JSONL evidence<br>**Data Store**: Postgres (`zeroui_tenant_pg`), JSONL (`ZU_ROOT/tenant/{tenant-id}/{region}/evidence/data/`)<br>**Contracts**: Core schema contract (identical to IDE), receipt index schema<br>**Evidence**: `infra/db/schema_pack/migrations/pg/001_core.sql`, `infra/db/migrations/tenant/001_core.sql` | **Runtime**: Postgres DB + pgvector, policy registry<br>**Data Store**: Postgres (`zeroui_product_pg`), policy files (`ZU_ROOT/product/{region}/policy/registry/`)<br>**Contracts**: Core schema contract (identical), policy bundle schema, vector embeddings schema<br>**Evidence**: `infra/db/schema_pack/migrations/pg/001_core.sql`, `infra/db/migrations/product/002_embeddings.sql` | **Runtime**: Postgres DB, shared artifacts<br>**Data Store**: Postgres (`zeroui_shared_pg`), shared files (`ZU_ROOT/shared/{org-id}/{region}/`)<br>**Contracts**: Core schema contract (identical), provider registry schema, eval run schema<br>**Evidence**: `infra/db/schema_pack/migrations/pg/001_core.sql`, `infra/db/migrations/shared/001_core.sql` |
| **L5: Security & Supply Chain** | **Runtime**: Policy trust store<br>**Data Store**: Public keys (`ZU_ROOT/ide/policy/trust/pubkeys/`)<br>**Contracts**: Public key schema<br>**Evidence**: `storage-scripts/folder-business-rules.md` (line 127) | **Runtime**: Tenant security services<br>**Data Store**: Tenant context (redacted), evidence (WORM)<br>**Contracts**: Evidence schema, context export schema<br>**Evidence**: `storage-scripts/folder-business-rules.md` (line 145, 137) | **Runtime**: Policy signing/verification<br>**Data Store**: Policy snapshots (signed), policy registry<br>**Contracts**: Policy snapshot schema, policy bundle schema<br>**Evidence**: `storage-scripts/folder-business-rules.md` (line 154) | **Runtime**: PKI, SBOM, supply chain<br>**Data Store**: PKI (`ZU_ROOT/shared/{org-id}/{region}/pki/`), SBOM (`ZU_ROOT/shared/{org-id}/{region}/security/sbom/`), supply chain (`ZU_ROOT/shared/{org-id}/{region}/security/supply-chain/`)<br>**Contracts**: SBOM schema, supply chain artifact schema<br>**Evidence**: `storage-scripts/folder-business-rules.md` (line 162, 178, 184) |
| **L6: Observability** | **Runtime**: Local logs<br>**Data Store**: Logs (`ZU_ROOT/ide/logs/`)<br>**Contracts**: Log schema (implicit)<br>**Evidence**: `storage-scripts/folder-business-rules.md` (line 133) | **Runtime**: Tenant telemetry<br>**Data Store**: Telemetry (`ZU_ROOT/tenant/{tenant-id}/{region}/telemetry/(metrics\|traces\|logs)/dt=.../`)<br>**Contracts**: Telemetry schema (implicit)<br>**Evidence**: `storage-scripts/folder-business-rules.md` (line 141) | **Runtime**: Product telemetry<br>**Data Store**: Telemetry (`ZU_ROOT/product/{region}/telemetry/(metrics\|traces\|logs)/dt=.../`)<br>**Contracts**: Telemetry schema (implicit)<br>**Evidence**: `storage-scripts/folder-business-rules.md` (line 158) | **Runtime**: Shared observability mesh, SIEM<br>**Data Store**: Telemetry (`ZU_ROOT/shared/{org-id}/{region}/telemetry/(metrics\|traces\|logs)/dt=.../`), SIEM (`ZU_ROOT/shared/{org-id}/{region}/siem/(detections\|events)/dt=.../`)<br>**Contracts**: SIEM schema (implicit)<br>**Evidence**: `storage-scripts/folder-business-rules.md` (line 163, 164) |
| **L7: Event Bus** | **Runtime**: Local queue (WAL)<br>**Data Store**: Queue (`ZU_ROOT/ide/queue/(pending\|sent\|failed)/`), WAL (local)<br>**Contracts**: Queue envelope schema<br>**Evidence**: `storage-scripts/folder-business-rules.md` (line 129), `src/shared_libs/cccs/receipts/wal.py` | **Runtime**: Redis Streams (event bus)<br>**Data Store**: Redis (`REDIS_URL`), tenant events<br>**Contracts**: Event schema (implicit)<br>**Evidence**: `infra/docker/compose.yaml` (redis service), `docs/architecture/database-runtime-mvp.md` (line 14) | **Runtime**: Redis Streams (event bus)<br>**Data Store**: Redis (`REDIS_URL`), product events<br>**Contracts**: Event schema (implicit)<br>**Evidence**: `infra/docker/compose.yaml` (redis service) | **Runtime**: Redis Streams (event bus)<br>**Data Store**: Redis (`REDIS_URL`), shared events<br>**Contracts**: Event schema (implicit)<br>**Evidence**: `infra/docker/compose.yaml` (redis service) |

**Note**: Layers L1-L7 are inferred from the three-tier architecture (Presentation, Edge Processing, Business Logic) plus cross-cutting concerns (Data & Memory, Security & Supply Chain, Observability, Event Bus). The repo does not explicitly document "7 layers" but the mapping above aligns with the architecture.

---

## B) Memory Types × Planes Grid

| Memory Type | IDE Plane | Tenant Plane | Product Plane | Shared Plane | Status |
|-------------|-----------|--------------|---------------|--------------|--------|
| **Working Memory (AgentState in Graph Runtime)** | **Store**: Postgres (`core.tenant`, `core.repo`, `core.actor` tables)<br>**Access**: Edge Agent runtime state<br>**Governance**: Local-only, no cloud sync<br>**Evidence**: `infra/db/schema_pack/migrations/pg/001_core.sql` | **Store**: Postgres (`core.tenant`, `core.repo`, `core.actor` tables)<br>**Access**: Tenant services<br>**Governance**: Tenant-scoped, ACID transactions<br>**Evidence**: `infra/db/schema_pack/migrations/pg/001_core.sql` | **Store**: Postgres (`core.tenant`, `core.repo`, `core.actor` tables)<br>**Access**: Product services<br>**Governance**: Product-scoped, ACID transactions<br>**Evidence**: `infra/db/schema_pack/migrations/pg/001_core.sql` | **Store**: Postgres (`core.tenant`, `core.repo`, `core.actor` tables)<br>**Access**: Shared services<br>**Governance**: Shared-scoped, ACID transactions<br>**Evidence**: `infra/db/schema_pack/migrations/pg/001_core.sql` | **IMPLEMENTED** (core schema tables serve as Working Memory; "Graph Runtime" = relational schema structure) |
| **Episodic Memory (Receipts + BKG edges)** | **Store**: JSONL receipts (`ZU_ROOT/ide/receipts/{repo-id}/{yyyy}/{mm}/`), Postgres receipt index (`core.receipt_index`), BKG edges (`core.bkg_edge` Phase 0 stub)<br>**Access**: Edge Agent, VS Code Extension<br>**Governance**: Append-only, signed receipts<br>**Evidence**: `storage-scripts/folder-business-rules.md` (line 125), `infra/db/schema_pack/migrations/pg/001_core.sql`, `infra/db/migrations/tenant/002_bkg_phase0.sql` | **Store**: JSONL evidence (`ZU_ROOT/tenant/{tenant-id}/{region}/evidence/data/`), Postgres receipt index (`core.receipt_index`), BKG edges (`core.bkg_edge` Phase 0 stub)<br>**Access**: Tenant services, evidence indexing service<br>**Governance**: WORM semantics, append-only<br>**Evidence**: `storage-scripts/folder-business-rules.md` (line 137), `infra/db/schema_pack/migrations/pg/001_core.sql`, `infra/db/migrations/tenant/002_bkg_phase0.sql` | **Store**: Postgres receipt index (`core.receipt_index`), policy registry, BKG edges (`core.bkg_edge` Phase 0 stub)<br>**Access**: Product services<br>**Governance**: Policy-governed access<br>**Evidence**: `infra/db/schema_pack/migrations/pg/001_core.sql`, `infra/db/migrations/product/003_bkg_phase0.sql` | **Store**: Postgres receipt index (`core.receipt_index`), BKG edges (`core.bkg_edge` Phase 0 stub)<br>**Access**: Shared services<br>**Governance**: Shared access, no tenant payloads<br>**Evidence**: `infra/db/schema_pack/migrations/pg/001_core.sql`, `infra/db/migrations/shared/002_bkg_phase0.sql` | **PHASE 0 STUB** (receipts exist; BKG edges schema created in all planes) |
| **Vector DB Memory (pgvector/embeddings)** | **Store**: N/A (no vector DB in IDE plane)<br>**Access**: N/A<br>**Governance**: N/A<br>**Evidence**: N/A | **Store**: N/A (no vector DB in tenant plane)<br>**Access**: N/A<br>**Governance**: N/A<br>**Evidence**: N/A | **Store**: Postgres (`app.embedding_document`, `app.embedding_vector` tables with `VECTOR(1536)` type)<br>**Access**: Context Service (via Product services)<br>**Governance**: pgvector extension, HNSW index for similarity search<br>**Evidence**: `infra/db/migrations/product/002_embeddings.sql`, `infra/docker/postgres/initdb/product-init.sh` | **Store**: N/A (no vector DB in shared plane)<br>**Access**: N/A<br>**Governance**: N/A<br>**Evidence**: N/A | **IMPLEMENTED** |
| **SQL DB Memory (structured metadata + BKG tables)** | **Store**: Postgres (`meta.schema_version`, `core.tenant`, `core.repo`, `core.actor`, `core.receipt_index`, `core.bkg_edge` Phase 0 stub)<br>**Access**: Edge Agent<br>**Governance**: Local-only, no cloud sync<br>**Evidence**: `infra/db/schema_pack/migrations/pg/001_core.sql`, `infra/db/migrations/tenant/002_bkg_phase0.sql` | **Store**: Postgres (`meta.schema_version`, `core.tenant`, `core.repo`, `core.actor`, `core.receipt_index`, `core.bkg_edge` Phase 0 stub, `app.tenant_receipt_index`, `app.tenant_integration_cursor`)<br>**Access**: Tenant services<br>**Governance**: ACID transactions, tenant-scoped<br>**Evidence**: `infra/db/schema_pack/migrations/pg/001_core.sql`, `infra/db/migrations/tenant/001_core.sql`, `infra/db/migrations/tenant/002_bkg_phase0.sql` | **Store**: Postgres (`meta.schema_version`, `core.tenant`, `core.repo`, `core.actor`, `core.receipt_index`, `core.bkg_edge` Phase 0 stub, `app.policy_bundle`, `app.policy_release`, `app.embedding_document`, `app.embedding_vector`)<br>**Access**: Product services<br>**Governance**: ACID transactions, product-scoped<br>**Evidence**: `infra/db/schema_pack/migrations/pg/001_core.sql`, `infra/db/migrations/product/001_core.sql`, `infra/db/migrations/product/002_embeddings.sql`, `infra/db/migrations/product/003_bkg_phase0.sql` | **Store**: Postgres (`meta.schema_version`, `core.tenant`, `core.repo`, `core.actor`, `core.receipt_index`, `core.bkg_edge` Phase 0 stub, `app.provider_registry`, `app.eval_run`, `app.supply_chain_artifact`)<br>**Access**: Shared services<br>**Governance**: ACID transactions, shared-scoped<br>**Evidence**: `infra/db/schema_pack/migrations/pg/001_core.sql`, `infra/db/migrations/shared/001_core.sql`, `infra/db/migrations/shared/002_bkg_phase0.sql` | **IMPLEMENTED** (BKG tables = `core.bkg_edge` in all planes, Phase 0 stub) |
| **File Store (raw artifacts, archives)** | **Store**: `ZU_ROOT/ide/` (receipts, policy, LLM artifacts, queue, logs)<br>**Access**: Edge Agent, VS Code Extension<br>**Governance**: Local-only, no cloud sync, JSONL receipts are source of truth<br>**Evidence**: `storage-scripts/folder-business-rules.md` (lines 125-133) | **Store**: `ZU_ROOT/tenant/{tenant-id}/{region}/` (evidence, telemetry, adapters, reporting, context)<br>**Access**: Tenant services, adapters<br>**Governance**: WORM semantics for evidence, retention policies<br>**Evidence**: `storage-scripts/folder-business-rules.md` (lines 137-150) | **Store**: `ZU_ROOT/product/{region}/` (policy registry, telemetry, evidence watermarks, reporting)<br>**Access**: Product services<br>**Governance**: Policy-governed access, signed snapshots<br>**Evidence**: `storage-scripts/folder-business-rules.md` (lines 154-160) | **Store**: `ZU_ROOT/shared/{org-id}/{region}/` (PKI, telemetry, SIEM, BI lake, governance, provider registry, eval, security)<br>**Access**: Shared services<br>**Governance**: Shared access, no tenant payloads<br>**Evidence**: `storage-scripts/folder-business-rules.md` (lines 162-189) | **IMPLEMENTED** |
| **Semantic Q&A Cache (cache rules + location + governance)** | **Store**: N/A (no Q&A cache in IDE plane)<br>**Access**: N/A<br>**Governance**: N/A<br>**Evidence**: N/A | **Store**: N/A (no Q&A cache in tenant plane)<br>**Access**: N/A<br>**Governance**: N/A<br>**Evidence**: N/A | **Store**: Postgres (`app.semantic_qa_cache` Phase 0 stub)<br>**Access**: Context Service (via Product services)<br>**Governance**: Hard rule: NOT used for gating decisions (informational only), TTL-based expiration<br>**Evidence**: `infra/db/migrations/product/004_semantic_qa_cache_phase0.sql` | **Store**: N/A (no Q&A cache in shared plane)<br>**Access**: N/A<br>**Governance**: N/A<br>**Evidence**: N/A | **PHASE 0 STUB** (schema created with governance rule: "NOT used for gating") |

---

## Summary

### Implemented Memory Types
- ✅ **Vector DB Memory**: Implemented in Product Plane (pgvector with `embedding_document` and `embedding_vector` tables)
- ✅ **SQL DB Memory**: Implemented in all planes (core schema tables + plane-specific app schema tables)
- ✅ **File Store**: Implemented in all planes (Four Plane storage fabric with `ZU_ROOT` paths)

### Implemented Memory Types (All)
- ✅ **Working Memory (AgentState in Graph Runtime)**: Core schema tables (`core.tenant`, `core.repo`, `core.actor`) serve as Working Memory. "Graph Runtime" refers to the relational schema structure.
- ✅ **Episodic Memory (BKG edges)**: Receipts exist (JSONL + DB index). BKG edges Phase 0 stub created (`core.bkg_edge` table in all planes).
- ✅ **Semantic Q&A Cache**: Phase 0 stub created (`app.semantic_qa_cache` table in Product Plane) with governance rule: "NOT used for gating decisions".

---

**Report Generated**: 2026-01-03  
**Updated**: 2026-01-03 (after memory model and BKG Phase 0 stub implementation)  
**Status**: Complete - **READY** ✅

