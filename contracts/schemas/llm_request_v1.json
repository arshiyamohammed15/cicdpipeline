{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "urn:zeroui:schemas:llm_request:v1",
  "title": "LLMRequest",
  "description": "Canonical ZeroUI envelope for every LLM Gateway & Safety Enforcement call.",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "request_id",
    "schema_version",
    "actor",
    "tenant",
    "logical_model_id",
    "operation_type",
    "system_prompt_id",
    "user_prompt",
    "context_segments",
    "policy_snapshot_id",
    "policy_version_ids",
    "sensitivity_level",
    "budget",
    "safety_overrides"
  ],
  "properties": {
    "request_id": {
      "type": "string",
      "pattern": "^[a-zA-Z0-9_-]{12,64}$",
      "description": "Stable identifier generated by caller; referenced in receipts."
    },
    "schema_version": {
      "type": "string",
      "const": "v1",
      "description": "Version pin for the envelope definition."
    },
    "actor": {
      "$ref": "#/definitions/actor"
    },
    "tenant": {
      "$ref": "#/definitions/tenant"
    },
    "workspace_id": {
      "type": "string",
      "description": "Optional workspace/project identifier used for routing."
    },
    "logical_model_id": {
      "type": "string",
      "minLength": 1,
      "description": "Policy-controlled logical name (not raw provider model)."
    },
    "operation_type": {
      "type": "string",
      "enum": [
        "chat",
        "completion",
        "embedding",
        "tool_suggest",
        "classification",
        "custom"
      ],
      "description": "LLM capability being requested."
    },
    "intended_capability": {
      "type": "string",
      "description": "Business-level capability (summarisation, refactor, incident_assist, etc.)."
    },
    "sensitivity_level": {
      "type": "string",
      "enum": ["low", "medium", "high"],
      "description": "Policy classification of the request payload."
    },
    "system_prompt_id": {
      "type": "string",
      "description": "Versioned identifier for the policy-managed system/meta prompt."
    },
    "user_prompt": {
      "type": "string",
      "minLength": 1,
      "description": "Raw user prompt supplied by caller. Only retained in memory."
    },
    "context_segments": {
      "type": "array",
      "description": "Structured context payloads with provenance and sanitisation hints.",
      "items": {
        "$ref": "#/definitions/context_segment"
      },
      "maxItems": 50
    },
    "policy_snapshot_id": {
      "type": "string",
      "description": "Identifier for the cached policy snapshot applied to this call."
    },
    "policy_version_ids": {
      "type": "array",
      "description": "List of policy/doc versions referenced by the snapshot.",
      "items": {
        "type": "string"
      },
      "minItems": 1,
      "uniqueItems": true
    },
    "budget": {
      "$ref": "#/definitions/budget"
    },
    "safety_overrides": {
      "$ref": "#/definitions/safety_overrides"
    },
    "dry_run": {
      "type": "boolean",
      "default": false,
      "description": "When true, execute safety/policy evaluation without calling the provider."
    },
    "telemetry_context": {
      "type": "object",
      "description": "Optional correlation identifiers for observability spans.",
      "additionalProperties": {
        "type": ["string", "number", "boolean"]
      }
    },
    "attachments": {
      "type": "array",
      "description": "Binary references (hashes) stored in tenant storage planes.",
      "items": {
        "$ref": "#/definitions/attachment"
      }
    }
  },
  "definitions": {
    "actor": {
      "type": "object",
      "required": ["actor_id", "actor_type", "roles", "capabilities"],
      "additionalProperties": false,
      "properties": {
        "actor_id": { "type": "string", "description": "IAM subject identifier." },
        "actor_type": {
          "type": "string",
          "enum": ["human", "agent", "service"]
        },
        "roles": {
          "type": "array",
          "items": { "type": "string" },
          "minItems": 1
        },
        "capabilities": {
          "type": "array",
          "items": { "type": "string" },
          "minItems": 1
        },
        "scopes": {
          "type": "array",
          "items": { "type": "string" }
        },
        "mfa_context": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "strength": { "type": "string" },
            "verified_at": { "type": "string", "format": "date-time" }
          }
        }
      }
    },
    "tenant": {
      "type": "object",
      "required": ["tenant_id", "region"],
      "additionalProperties": false,
      "properties": {
        "tenant_id": { "type": "string" },
        "region": { "type": "string" },
        "data_residency": { "type": "string" }
      }
    },
    "context_segment": {
      "type": "object",
      "required": ["segment_id", "segment_type", "label", "sensitivity", "content_ref"],
      "additionalProperties": false,
      "properties": {
        "segment_id": { "type": "string" },
        "segment_type": {
          "type": "string",
          "enum": [
            "retrieved_docs",
            "code_snippets",
            "logs",
            "tickets",
            "external_web",
            "conversation_history",
            "custom"
          ]
        },
        "label": { "type": "string" },
        "sensitivity": {
          "type": "string",
          "enum": ["public", "internal", "confidential", "restricted"]
        },
        "content_ref": {
          "type": "object",
          "required": ["hash", "location"],
          "properties": {
            "hash": { "type": "string" },
            "location": { "type": "string" }
          }
        },
        "truncated": { "type": "boolean", "default": false },
        "source": {
          "type": "object",
          "properties": {
            "origin": { "type": "string" },
            "ingested_at": { "type": "string", "format": "date-time" }
          }
        }
      }
    },
    "budget": {
      "type": "object",
      "required": ["max_tokens", "timeout_ms", "priority"],
      "additionalProperties": false,
      "properties": {
        "max_tokens": { "type": "integer", "minimum": 1, "maximum": 32768 },
        "timeout_ms": { "type": "integer", "minimum": 100, "maximum": 120000 },
        "priority": {
          "type": "string",
          "enum": ["low", "normal", "high", "critical"]
        },
        "temperature": { "type": "number", "minimum": 0, "maximum": 2 },
        "top_p": { "type": "number", "minimum": 0, "maximum": 1 },
        "tool_allowlist": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },
    "safety_overrides": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "fail_open_allowed": { "type": "boolean", "default": false },
        "degradation_mode": {
          "type": "string",
          "enum": ["default", "prefer_backup", "simulation_only"],
          "default": "default"
        },
        "risk_tolerance": {
          "type": "string",
          "enum": ["strict", "balanced", "permissive"],
          "default": "strict"
        }
      }
    },
    "attachment": {
      "type": "object",
      "required": ["attachment_id", "type", "hash"],
      "properties": {
        "attachment_id": { "type": "string" },
        "type": { "type": "string" },
        "hash": { "type": "string" },
        "expires_at": { "type": "string", "format": "date-time" }
      }
    }
  }
}

