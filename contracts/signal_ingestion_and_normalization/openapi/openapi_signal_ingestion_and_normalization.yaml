openapi: 3.1.0
info:
  title: "Signal Ingestion & Normalization API"
  description: "API for ingesting, validating, normalizing, and routing signals per PRD v1.0"
  version: "1.0.0"
servers:
  - url: http://localhost:8000
    description: Local development server
paths:
  /v1/signals/ingest:
    post:
      summary: Ingest signals
      description: Ingest signals per F3.2. Accepts batch of signals, returns per-signal results.
      operationId: ingestSignals
      tags:
        - signal-ingestion
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IngestRequest'
      responses:
        '200':
          description: Signals ingested
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IngestResponse'
        '401':
          description: Unauthorized
        '500':
          description: Internal server error

  /v1/signals/dlq:
    get:
      summary: Inspect DLQ entries
      description: Inspect DLQ entries per F8. Returns DLQ entries with optional filters.
      operationId: inspectDLQ
      tags:
        - signal-ingestion
      security:
        - BearerAuth: []
      parameters:
        - name: tenant_id
          in: query
          schema:
            type: string
        - name: producer_id
          in: query
          schema:
            type: string
        - name: signal_type
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 100
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: DLQ entries
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DLQInspectionResponse'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden

  /v1/producers/register:
    post:
      summary: Register producer
      description: Register producer per F2.1. Register producer with allowed signal types and contracts.
      operationId: registerProducer
      tags:
        - signal-ingestion
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProducerRegistrationRequest'
      responses:
        '201':
          description: Producer registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProducerRegistrationResponse'
        '400':
          description: Bad request
        '401':
          description: Unauthorized

  /v1/producers/{producer_id}:
    get:
      summary: Get producer
      description: Get producer registration per F2.1.
      operationId: getProducer
      tags:
        - signal-ingestion
      security:
        - BearerAuth: []
      parameters:
        - name: producer_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Producer registration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProducerRegistrationRequest'
        '404':
          description: Not found
        '401':
          description: Unauthorized
    put:
      summary: Update producer
      description: Update producer registration per F2.1.
      operationId: updateProducer
      tags:
        - signal-ingestion
      security:
        - BearerAuth: []
      parameters:
        - name: producer_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProducerRegistrationRequest'
      responses:
        '200':
          description: Producer updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProducerRegistrationResponse'
        '400':
          description: Bad request
        '401':
          description: Unauthorized

  /v1/health:
    get:
      summary: Health check
      description: Health check endpoint per F9.
      operationId: healthCheck
      tags:
        - signal-ingestion
      responses:
        '200':
          description: Health status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /v1/ready:
    get:
      summary: Readiness check
      description: Readiness check endpoint per F9.
      operationId: readinessCheck
      tags:
        - signal-ingestion
      responses:
        '200':
          description: Readiness status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReadinessResponse'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    SignalEnvelope:
      type: object
      required:
        - signal_id
        - tenant_id
        - environment
        - producer_id
        - signal_kind
        - signal_type
        - occurred_at
        - ingested_at
        - payload
        - schema_version
      properties:
        signal_id:
          type: string
        tenant_id:
          type: string
        environment:
          type: string
          enum: [dev, stage, prod]
        producer_id:
          type: string
        actor_id:
          type: string
        signal_kind:
          type: string
          enum: [event, metric, log, trace]
        signal_type:
          type: string
        occurred_at:
          type: string
          format: date-time
        ingested_at:
          type: string
          format: date-time
        trace_id:
          type: string
        span_id:
          type: string
        correlation_id:
          type: string
        resource:
          type: object
        payload:
          type: object
          additionalProperties: true
        schema_version:
          type: string
        sequence_no:
          type: integer

    IngestRequest:
      type: object
      required:
        - signals
      properties:
        signals:
          type: array
          items:
            $ref: '#/components/schemas/SignalEnvelope'
          minItems: 1
          maxItems: 1000

    SignalIngestResult:
      type: object
      required:
        - signal_id
        - status
      properties:
        signal_id:
          type: string
        status:
          type: string
          enum: [accepted, rejected, dlq]
        error_code:
          type: string
        error_message:
          type: string
        dlq_id:
          type: string
        warnings:
          type: array
          items:
            type: string

    IngestResponse:
      type: object
      required:
        - results
        - summary
      properties:
        results:
          type: array
          items:
            $ref: '#/components/schemas/SignalIngestResult'
        summary:
          type: object
          properties:
            total:
              type: integer
            accepted:
              type: integer
            rejected:
              type: integer
            dlq:
              type: integer

    DLQInspectionResponse:
      type: object
      required:
        - entries
        - total
      properties:
        entries:
          type: array
          items:
            type: object
        total:
          type: integer

    ProducerRegistrationRequest:
      type: object
      required:
        - producer
      properties:
        producer:
          type: object

    ProducerRegistrationResponse:
      type: object
      required:
        - producer_id
        - status
      properties:
        producer_id:
          type: string
        status:
          type: string
        message:
          type: string

    HealthResponse:
      type: object
      required:
        - status
        - timestamp
      properties:
        status:
          type: string
        timestamp:
          type: string
          format: date-time

    ReadinessResponse:
      type: object
      required:
        - ready
        - checks
        - timestamp
      properties:
        ready:
          type: boolean
        checks:
          type: object
        timestamp:
          type: string
          format: date-time
