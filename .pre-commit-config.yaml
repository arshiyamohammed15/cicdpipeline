# Pre-commit configuration for ZeroUI 2.0
# Aligned with pyproject.toml tool configurations

repos:
  # Ruff - Fast Python linter and formatter
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.14.1
    hooks:
      - id: ruff
        args: [--fix, --exit-non-zero-on-fix]
        types: [python]
      - id: ruff-format
        types: [python]

  # Black - Python code formatter
  - repo: https://github.com/psf/black
    rev: 25.9.0
    hooks:
      - id: black
        language_version: python3.11
        args: [--line-length=88, --target-version=py311]

  # MyPy - Static type checker
  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.18.2
    hooks:
      - id: mypy
        additional_dependencies: [
          types-PyYAML==6.0.12.20250915,
          types-requests==2.32.4.20250913,
          pydantic==2.12.3,
        ]
        args: [--strict, --show-error-codes, --pretty]
        files: ^(config|validator)/.*\.py$

  # General hooks
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v5.0.0
    hooks:
      # File checks
      - id: trailing-whitespace
        exclude: \.md$
      - id: end-of-file-fixer
        exclude: \.md$
      - id: check-yaml
        args: [--unsafe]
      - id: check-json
      - id: check-toml
      - id: check-merge-conflict
      - id: check-case-conflict
      - id: check-added-large-files
        args: [--maxkb=1000]
      
      # Python-specific checks
      - id: check-ast
      - id: check-merge-conflict
      - id: debug-statements
      - id: check-docstring-first
      
      # Security checks
      - id: detect-private-key
      - id: detect-aws-credentials
      
      # Git hooks
      - id: check-commit-msg
        args: [--commit-msg-filename]
      - id: check-merge-conflict
      
      # File formatting
      - id: mixed-line-ending
        args: [--fix=lf]
      - id: check-merge-conflict

  # Node.js hooks for VS Code extension
  - repo: https://github.com/pre-commit/mirrors-eslint
    rev: v9.17.0
    hooks:
      - id: eslint
        files: \.(js|ts)$
        types: [file]
        additional_dependencies:
          - eslint@^9.17.0
          - '@typescript-eslint/parser@^8.0.0'
          - '@typescript-eslint/eslint-plugin@^8.0.0'
        args: [--fix, --max-warnings=0]

  # TypeScript compilation check
  - repo: local
    hooks:
      - id: typescript-compile-check
        name: TypeScript Compile Check
        entry: bash -c 'cd src/vscode-extension && npx tsc --noEmit'
        language: system
        files: \.(ts|tsx)$
        pass_filenames: false

  # Custom hooks for ZeroUI 2.0
  - repo: local
    hooks:
      # Validate constitution rules
      - id: validate-constitution
        name: Validate Constitution Rules
        entry: python -m validator.core --validate-config
        language: system
        files: ^config/.*\.json$
        pass_filenames: false
        always_run: false

      # Check for TODO/FIXME comments
      - id: check-todos
        name: Check for TODO/FIXME comments
        entry: bash -c 'if grep -r "TODO\|FIXME\|XXX\|HACK" --include="*.py" --include="*.ts" --include="*.js" .; then echo "Found TODO/FIXME comments. Please address them."; exit 1; fi'
        language: system
        pass_filenames: false

      # Ensure all Python files have proper imports
      - id: check-imports
        name: Check Python imports
        entry: python -c "
import ast
import sys
import os

def check_file(filepath):
    try:
        with open(filepath, 'r', encoding='utf-8') as f:
            content = f.read()
        
        # Skip if file is empty or only contains comments
        if not content.strip() or content.strip().startswith('#'):
            return True
            
        tree = ast.parse(content, filename=filepath)
        
        # Check for proper import structure
        imports = [node for node in ast.walk(tree) if isinstance(node, (ast.Import, ast.ImportFrom))]
        
        # Basic validation - ensure no wildcard imports in production code
        for node in imports:
            if isinstance(node, ast.ImportFrom) and node.names and node.names[0].name == '*':
                if not filepath.endswith('__init__.py'):
                    print(f'Warning: Wildcard import found in {filepath}')
                    return False
        
        return True
    except Exception as e:
        print(f'Error parsing {filepath}: {e}')
        return False

# Check all Python files
for root, dirs, files in os.walk('.'):
    # Skip virtual environments and cache directories
    dirs[:] = [d for d in dirs if d not in {'.venv', '__pycache__', '.git', 'node_modules', 'dist', 'build'}]
    
    for file in files:
        if file.endswith('.py'):
            filepath = os.path.join(root, file)
            if not check_file(filepath):
                sys.exit(1)
"
        language: system
        files: \.py$
        pass_filenames: false

# Configuration
ci:
  autofix_commit_msg: |
    [pre-commit.ci] auto fixes from pre-commit.com hooks

    for more information, see https://pre-commit.ci
  autofix_prs: true
  autoupdate_branch: ''
  autoupdate_commit_msg: '[pre-commit.ci] pre-commit autoupdate'
  autoupdate_schedule: weekly
  skip: []
  submodules: false
